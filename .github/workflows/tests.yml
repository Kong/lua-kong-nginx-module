name: Tests

on: [push, pull_request]

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-20.04

    env:
      JOBS: 2
      INSTALL_CACHE: /home/runner/work/install-cache
      INSTALL_ROOT: /home/runner/work/install-root
      DOWNLOAD_ROOT: /home/runner/work/download-root

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        submodules: 'true'

    - name: Setup cache
      uses: actions/cache@v2
      with:
        path: |
          /home/runner/work/install-cache
        key: ${{ runner.os }}-${{ hashFiles('**/tests.yml') }}-${{ hashFiles('**/*.c', '**/*.h') }}

    - name: Setup tools
      run: |
        sudo apt-get update
        sudo apt-get install -qq -y postgresql cpanminus net-tools libpcre3-dev build-essential valgrind
        source .github/workflows/setup_env.sh

    - name: Run Test
      run: |
        export OPENSSL_INSTALL=$INSTALL_ROOT/openssl
        export OPENSSL_DIR=$OPENSSL_INSTALL
        export OPENRESTY_INSTALL=$INSTALL_ROOT/openresty
        export LUAROCKS_INSTALL=$INSTALL_ROOT/luarocks
        export PATH=$OPENRESTY_INSTALL/nginx/sbin:$OPENRESTY_INSTALL/bin:$LUAROCKS_INSTALL/bin:$PATH
        export LD_LIBRARY_PATH=$OPENSSL_INSTALL/lib:$LD_LIBRARY_PATH # for openssl's CLI invoked in the test suite
        eval `luarocks path`
        echo $PATH
        prove -j$JOBS -r t

